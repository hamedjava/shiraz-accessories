/**
 * =============================================
 * ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Express
 * Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù†ÛŒØªØŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ Ù„Ø§Ú¯ØŒ Ùˆ Mount Ú©Ø±Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
 * ---------------------------------------------
 * Ø§ÛŒÙ† ÙØ§ÛŒÙ„ ÙÙ‚Ø· Ù…Ø³Ø¦ÙˆÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø·Ø­ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø§Ø³ØªØŒ
 * Ù†Ù‡ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÛŒØ§ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±.
 * =============================================
 */

import express from "express";
import helmet from "helmet";                   // Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Ù‡Ø¯Ø±Ù‡Ø§ÛŒ HTTP Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø­Ù…Ù„Ø§Øª Ù…Ø¹Ø±ÙˆÙ
import cors from "cors";                       // Ù…Ø¬Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø§Ù…Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Cross-Origin)
import morgan from "morgan";                   // Ø«Ø¨Øª Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡
import rateLimit from "express-rate-limit";    // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù†Ø±Ø® Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§

// ğŸ§© Middleware Ù‡Ù†Ø¯Ù„Ø± Ø®Ø·Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Global Error Handler)
import { errorHandler } from "./core/middlewares/errorHandler.js";

// ğŸ§© ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… (Case-sensitive! Ù…Ø®ØµÙˆØµ Ù„ÛŒÙ†ÙˆÚ©Ø³)
import adminRoutes from "./modules/user/admin/interfaces/http/adminRoutes.js";
import sellerRoutes from "./modules/user/seller/interfaces/http/seller-routes.js";

// ğŸ§© Ù…Ø³ÛŒØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† (Customers)
import customerRoutes from "./modules/user/customer/interfaces/http/customer-routes.js";

// âœ… Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø§ØµÙ„ÛŒ Express
const app = express();

/* ============================================================
   ğŸ“˜ Ø¨Ø®Ø´ Ø§Ù…Ù†ÛŒØªØŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒØŒ Ùˆ MiddlewareÙ‡Ø§ÛŒ Ø³Ø·Ø­ Ø¨Ø§Ù„Ø§
============================================================ */

// ğŸ›¡ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Helmet Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡ Ùˆ Production
app.use(
  helmet({
    contentSecurityPolicy: false, // Ø¯Ø± Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡ SPA Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØ¯Ø§Ø®Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯ØŒ Ù¾Ø³ ØºÛŒØ±ÙØ¹Ø§Ù„
    crossOriginResourcePolicy: { policy: "same-origin" }, // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø² Ø¯Ø§Ù…Ù†Ù‡ Ø¯ÛŒÚ¯Ø±
  })
);

// ğŸŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ CORS (Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨ÛŒÙ† Ø¯Ø§Ù…Ù†Ù‡â€ŒÙ‡Ø§ Ù…Ø«Ù„ frontend Ø¬Ø¯Ø§ Ø§Ø² backend)
app.use(cors());

// ğŸ’¾ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ parser Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ JSON Ø¯Ø± body Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
app.use(express.json());

// ğŸ§¾ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ú¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡ (Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§)
app.use(morgan("dev"));

// ğŸš¦ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø±Ø® Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² brute-force Ùˆ Ø­Ù…Ù„Ø§Øª DoS
app.use(
  rateLimit({
    windowMs: 60 * 1000, // Ø¨Ø§Ø²Ù‡ ÛŒÚ© Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ
    max: 60, // Ø­Ø¯Ø§Ú©Ø«Ø± Û¶Û° Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± IP
    message: "ğŸš« ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
    standardHeaders: true, // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ø±Ø¨Ø±Ú¯ RateLimit Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
    legacyHeaders: false,  // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø³Ø±Ø¨Ø±Ú¯â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ RateLimit
  })
);

/* ============================================================
   âœ… Ù…Ø³ÛŒØ± ØªØ³Øª Ø³Ù„Ø§Ù…Øª / ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±
============================================================ */
app.get("/api", (req, res) => {
  res.status(200).json({
    status: "OK",
    message: "âœ… API ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.",
    timestamp: new Date().toISOString(),
  });
});

/* ============================================================
   ğŸ“¦ Mount Ú©Ø±Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø³ÛŒØ³ØªÙ…
============================================================ */

// Ù…Ø³ÛŒØ± Ù…Ø¯ÛŒØ±Ø§Ù† (Admins)
app.use("/api/admins", adminRoutes);

// Ù…Ø³ÛŒØ± ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† (Sellers)
app.use("/api/sellers", sellerRoutes);

// Ù…Ø³ÛŒØ± Ù…Ø´ØªØ±ÛŒØ§Ù† (Customers)
app.use("/api/customers", customerRoutes);

/* ============================================================
   âš ï¸ Ù‡Ù†Ø¯Ù„Ø± Ù†Ù‡Ø§ÛŒÛŒ Ø®Ø·Ø§Ù‡Ø§ (Global Error Handling)
============================================================ */
// Ù‡Ø± Ø®Ø·Ø§ÛŒÛŒ Ø§Ø² routeÙ‡Ø§ Ø¹Ø¨ÙˆØ± Ú©Ù†Ø¯ Ø¯Ø± Ø§ÛŒÙ† Middleware Ù‡Ù†Ø¯Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
app.use(errorHandler);

/* ============================================================
   ğŸ“¤ Export Ú©Ø±Ø¯Ù† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ÙØ§ÛŒÙ„ server.js
============================================================ */
export default app;
