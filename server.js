/**
 * =============================================
 * ูุงู ุงุตู ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ Node.js
 * ูุณุฆูู ุงุชุตุงู ุจู ุฏุชุงุจุณุ ุจุงุฑฺฏุฐุงุฑ ุชูุธูุงุช envุ
 * ู ุงุฌุฑุง ุงูพูฺฉุดู Express ุฏุฑ ูพูุฑุช ูุดุฎุตโุดุฏู.
 * ---------------------------------------------
 * ุงู ูุงู ููุท Bootstrapping ุงูุฌุงู ูโุฏูุฏ.
 * =============================================
 */

import dotenv from "dotenv";            // ๐ฆ ุจุงุฑฺฏุฐุงุฑ ูุงู env ุจุฑุง ูุฏุฑุช ุชูุธูุงุช ุญุณุงุณ
import app from "./src/app.js";         // ๐ ุงูพูฺฉุดู ุงุตู Express
import connectDB from "./src/config/database.js"; // โ๏ธ ุชุงุจุน ุงุชุตุงู ุจู MongoDB

// ุจุงุฑฺฏุฐุงุฑ ูุชุบุฑูุง ูุญุท ุงุฒ ูุงู .env
dotenv.config();

/* ============================================================
   โ๏ธ ุชูุธูุงุช ูพุงู ุณุณุชู ุงุฒ .env ุง ููุฏุงุฑ ูพุดโูุฑุถ
============================================================ */
const PORT = process.env.PORT || 3000;
const DB_URI = process.env.DB_URI || "mongodb://127.0.0.1:27017/cleanarch-shop";

/* ============================================================
   ๐ ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ ู ุงุชุตุงู ูพุงฺฏุงู ุฏุงุฏู
============================================================ */

(async () => {
  try {
    // ๐งฉ ุงุชุตุงู ุจู ูพุงฺฏุงู ุฏุงุฏู MongoDB ุจุง ุขุฏุฑุณ ูุดุฎุตโุดุฏู
    await connectDB(DB_URI);
    console.log("โ ุงุชุตุงู ูููู ุจู ูพุงฺฏุงู ุฏุงุฏู ุจุฑูุฑุงุฑ ุดุฏ");

    // ุฏุฑ ุญุงูุช ุชุณุชุ ุณุฑูุฑ ูุจุงุฏ ูุงูุนุง listen ฺฉูุฏ ุชุง Jest ูพุฑูุณู ุฑุง ุจุงุฒ ูฺฏู ูุฏุงุฑุฏ
    if (process.env.NODE_ENV !== "test") {
      // ๐ ุงุฌุฑุง ุงูพูฺฉุดู ุฑู ูพูุฑุช ูุดุฎุต ุดุฏู
      app.listen(PORT, () => {
        console.clear(); // ูพุงฺฉ ฺฉุฑุฏู ุตูุญู ุชุฑููุงู ุจุฑุง ููุงุด ุชูุฒุชุฑ
        console.log("===============================================");
        console.log(" ๐  Clean Architecture Shop Backend Started");
        console.log("===============================================");
        console.log(`๐  API URL:        http://localhost:${PORT}/api`);
        console.log(`๐  Database URI:   ${DB_URI}`);
        console.log(`๐  Environment:    ${process.env.NODE_ENV || "development"}`);
        console.log("===============================================");
        console.log("๐ก  Listening for incoming requests...");
        console.log("===============================================");
      });
    }
  } catch (err) {
    // โ ููุฏู ุฎุทุง ุฏุฑ ุงุชุตุงู ุฏุชุงุจุณ
    console.error("===============================================");
    console.error("โ ุฎุทุง ุฏุฑ ุงุชุตุงู ูพุงฺฏุงู ุฏุงุฏู MongoDB");
    console.error("ุฌุฒุฆุงุช:", err.message);
    console.error("ูุทูุงู ุชูุธูุงุช ูุงู .env ุง ูุถุนุช MongoDB ุฑุง ุจุฑุฑุณ ฺฉูุฏ.");
    console.error("===============================================");

    // ููุท ุฏุฑ ุญุงูุช ุบุฑู ุชุณุช ุฎุงุฑุฌ ุดู ุชุง Jest ูพุฑูุณู ุฑุง ูุชููู ูฺฉูุฏ
    if (process.env.NODE_ENV !== "test") {
      process.exit(1); // ุฎุฑูุฌ ุงุฒ ูพุฑูุณู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุฌุฑุง ุณุฑูุฑ ุจุฏูู ุงุชุตุงู DB
    }
  }
})();

/* ============================================================
   ๐ค ุงฺฉุณูพูุฑุช ุงูพูฺฉุดู ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุชุณุชโูุง ู ุณุงุฑ ูุงฺููโูุง
============================================================ */
export default app;
